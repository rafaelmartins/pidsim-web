<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>Simulador de Controladores PID</title>
        <script src="http://files.rafaelmartins.eng.br/js/jquery.min.js" type="text/javascript"></script>
        <script src="http://files.rafaelmartins.eng.br/js/jquery.validate.js" type="text/javascript"></script>
        <script type="text/javascript">
        var model = null;
        var blacklist = [4, 8, 9, 14];
        function select_model(my_model) {
            var temp = true;
            // Block models not implemented yet
            for(i in blacklist){
                if(my_model == blacklist[i]){
                    window.alert("Processo não implementado!");
                    temp = false;
                }
            }
            if(temp){
                model = my_model;
                $("#graph").html('');
                $.getJSON('model/' + model, function(data) {
                    $('#model_id').html(data.model['id']);
                    $('#model_img').attr('src', data.model['img']);
                    if(data.model['form'] != null){
                        $('#additional_form').html(data.model['form']);
                    }
                    else{
                        $('#additional_form').html("Sem parametros.");
                    }
                    $('#selected_model').show();
                    $('#what').val('1');
                });
            }
        }
        
        $(document).ready(function() {
            $("#t_method").change(function(){
                if($(this).val() == "0"){
                    $("#pid_parameters").show();
                    $("#what").hide();
                }
                else{
                    $("#pid_parameters").hide();
                    $("#show").show();
                }
            });
            $("#options").validate({
                onsubmit: true,
                onfocusout: false,
                onkeyup: false,
                onclick: false,
                submitHandler: function(form) {
                    // Validation to save resources :P
                    if(($("#total").val() / $("#sample").val()) > 5000){
                        window.alert(
                            "Erro: \n\nSeu gráfico teria mais de 5000 pontos.\n" + 
                            "Por favor, diminua o Tempo Total ou aumente o Tempo de Amostragem."
                        );
                        return false;
                    }
                    // Wow, we have a model to plot! :D
                    ts = Math.round(new Date().getTime() / 1000);
                    img_url = 'plot/' + model + '?' + $("#options").serialize();
                    $('#graph').html('<img src="' + img_url + '&uts=' + ts + '" />');
                    return false;
                },
                showErrors: function(errorMap, errorList) {
                    if(errorList.length > 0) {
                        // Dammit!
                        var aux = "Erros:\n\n";
                        for(key in errorMap) {
                            aux += key + ": " + errorMap[key] + "\n";
                        }
                        window.alert(aux);
                    }
                }
            });
        });
        </script>
        <style type="text/css">
        /* html elements */
        * {
            margin: 0;
            padding: 0;
        }
        body {
            font-family: Verdana;
            text-align: center;
        }
        h1 {
            margin: 10px auto;
        }
        th {
            padding-bottom: 7px;
        }
        label {
            float: left;
        }
        hr {
            margin-bottom: 10px;
        }
        a img {
            border: none;
            margin: 5px;
        }
        
        /* table models */
        #models {
            margin: 0 auto;
            margin-bottom: 15px;
        }
        #models input {
            width: 100px;
        }
        
        /* div selected_model */
        #selected_model {
            display: none;
        }
        #selected_model p{
            margin-bottom: 10px;
        }
        
        /* table table_selected_model */
        #table_selected_model {
            width: 630px;
            margin: 0 auto;
            margin-bottom: 15px;
        }
        #table_selected_model table {
            margin: 0 auto;
        }
        
        /* tables table_options and pid_parameters */
        #table_options, #pid_parameters {
            margin: 0 auto;
            margin-bottom: 15px;
        }
        #table_options input, #table_options select, #pid_parameters input {
            width: 200px;
        }
        #pid_parameters {
            display: none;
        }
        
        /* paragraph footer */
        #footer {
            font-size: x-small;
        }
        
        /* div graph */ 
        #graph {
            margin-bottom: 10px;
        }
        </style>
    </head>
    <body>
        <h1>Simulador de Controladores PID</h1>
        <table id="models">
            <tr>
                <th colspan="5">Escolha um processo para simular:</th>
            </tr>
            <tr>
                <td><input type="button" value="Processo 1" onclick="select_model(1)" /></td>
                <td><input type="button" value="Processo 2" onclick="select_model(2)" /></td>
                <td><input type="button" value="Processo 3" onclick="select_model(3)" /></td>
                <td><input type="button" value="Processo 4" onclick="select_model(4)" /></td>
                <td><input type="button" value="Processo 5" onclick="select_model(5)" /></td>
            </tr>
            <tr>
                <td><input type="button" value="Processo 6" onclick="select_model(6)" /></td>
                <td><input type="button" value="Processo 7" onclick="select_model(7)" /></td>
                <td><input type="button" value="Processo 8" onclick="select_model(8)" /></td>
                <td><input type="button" value="Processo 9" onclick="select_model(9)" /></td>
                <td><input type="button" value="Processo 10" onclick="select_model(10)" /></td>
            </tr>
            <tr>
                <td><input type="button" value="Processo 11" onclick="select_model(11)" /></td>
                <td><input type="button" value="Processo 12" onclick="select_model(12)" /></td>
                <td><input type="button" value="Processo 13" onclick="select_model(13)" /></td>
                <td><input type="button" value="Processo 14" onclick="select_model(14)" /></td>
                <td>&nbsp;</td>
            </tr>
        </table>
        <div id="selected_model">
            <form id="options">
                <table id="table_selected_model">
                    <tr>
                        <th>Processo selecionado: <span id="model_id"></span></th>
                        <th>Parâmetros do processo</th>
                    </tr>
                    <tr>
                        <td><img id="model_img" /></td>
                        <td id="additional_form"></td>
                    </tr>
                </table>
                <table id="table_options">
                    <tr>
                        <th colspan="2">Opções</th>
                    </tr>
                    <tr>
                        <td><label for="n_method">Método numérico para discretização:</label></td>
                        <td>
                            <select name="n_method">
                                <option value="1">Euler</option>
                                <option value="2">Runge-Kutta de 2ª ordem</option>
                                <option value="3">Runge-Kutta de 3ª ordem</option>
                                <option value="4">Runge-Kutta de 4ª ordem</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td><label for="t_method">Metodo de sintonia para o controlador:</label></td>
                        <td>
                            <select name="t_method" id="t_method">
                                <option value="1">Ziegler Nichols</option>
                                <option value="2">Cohen Coon</option>
                                <option value="3">Chien Hrones Reswick 0%</option>
                                <option value="4">Chien Hrones Reswick 20%</option>
                                <option value="0">Manual</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td><label for="sample">Tempo de amostragem (em segundos):</label></td>
                        <td><input type="text" class="required number" id="sample" name="Sample_Time" /></td>
                    </tr>
                    <tr>
                        <td><label for="time">Tempo total de simulação (em segundos):</label></td>
                        <td><input type="text" class="required number" id="total" name="Total_Time" /></td>
                    </tr>
                </table>
                <table id="pid_parameters">
                    <tr>
                        <th colspan="2">Parametros do Controlador PID</th>
                    </tr>
                    <tr>
                        <td><label for="sample">Ganho proporcional (kp):</label></td>
                        <td><input type="text" class="required number" id="kp" name="kp" /></td>
                    </tr>
                    <tr>
                        <td><label for="sample">Ganho integral (ki):</label></td>
                        <td><input type="text" class="required number" id="ki" name="ki" /></td>
                    </tr>
                    <tr>
                        <td><label for="sample">Ganho derivativo (kd):</label></td>
                        <td><input type="text" class="required number" id="kd" name="kd" /></td>
                    </tr>
                </table>
                <p>
                    <select name="what" id="what">
                        <option value="1">Identificação do processo (Curva de Reação)</option>
                        <option value="2">Simulação do controlador PID</option>
                    </select>
                    <input id="plot_button" type="submit" value="Plotar!" />
                </p>
            </form>
        </div>
        <div id="graph"></div>
        <hr />
        <p id="footer">
            &copy;2009-2010 Rafael Gonçalves Martins.<br />
            <a href="http://www.python.org">
                <img src="http://www.python.org/community/logos/python-powered-w-100x40.png" />
            </a>
        </p>
    </body>
</html>
